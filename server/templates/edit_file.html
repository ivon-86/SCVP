{% extends "layout.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å {{ filename }} - {{ repo.name }} - SCVP{% endblock %}

{% block extra_css %}
<style>
    .edit-file-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .edit-file-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 3px double;
    }
    
    .file-actions {
        display: flex;
        gap: 10px;
    }
    
    .editor-container {
        display: flex;
        gap: 30px;
        margin-bottom: 40px;
    }
    
    .editor-section {
        flex: 2;
    }
    
    .info-section {
        flex: 1;
        min-width: 300px;
    }
    
    .editor-box {
        border: 3px double;
        padding: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    textarea.form-control {
        width: 100%;
        padding: 15px;
        border: 2px solid;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        min-height: 400px;
        resize: vertical;
        white-space: pre;
        overflow-wrap: normal;
        overflow-x: auto;
    }
    
    textarea.form-control:focus {
        outline: none;
        border-color: #333;
        box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
    }
    
    .btn {
        display: inline-block;
        padding: 10px 20px;
        text-decoration: none;
        border: 2px solid;
        background-color: transparent;
        color: inherit;
        cursor: pointer;
        font-family: 'Courier New', monospace;
        font-size: 16px;
        text-align: center;
    }
    
    .btn:hover {
        background-color: inherit;
        color: inherit;
    }
    
    .btn-primary {
        background-color: #000;
        color: #fff;
    }
    
    .btn-primary:hover {
        background-color: #333;
        border-color: #333;
    }
    
    .btn-secondary {
        background-color: #f0f0f0;
    }
    
    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    
    .file-info {
        border: 2px solid;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .file-info ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .file-info li {
        margin-bottom: 8px;
    }
    
    .file-tips {
        border: 2px solid;
        padding: 20px;
        background-color: rgba(0,0,0,0.05);
    }
    
    .file-tips h4 {
        margin-top: 0;
    }
    
    .file-tips ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .file-tips li {
        margin-bottom: 8px;
    }
    
    .editor-tools {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid;
    }
    
    .file-stats {
        font-size: 0.9em;
        color: #666;
    }
    
    @media (max-width: 768px) {
        .edit-file-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .file-actions {
            width: 100%;
            justify-content: space-between;
        }
        
        .editor-container {
            flex-direction: column;
        }
        
        .info-section {
            min-width: auto;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .form-actions .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-file-container">
    <div class="edit-file-header">
        <h1>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª</h1>
        <div class="file-actions">
            <a href="{{ url_for('main.repo_view', repo_id=repo.id) }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é</a>
            <a href="{{ url_for('main.download_file', repo_id=repo.id, filepath=filepath) }}" 
               class="btn" 
               title="–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª">
                ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å
            </a>
        </div>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    <div class="editor-container">
        <div class="editor-section">
            <div class="editor-box">
                <div class="editor-tools">
                    <div>
                        <strong>üìÑ –§–∞–π–ª:</strong> {{ form.filename.data }}
                    </div>
                    <div class="file-stats">
                        {% set content = form.content.data %}
                        {% set lines = content.split('\n')|length %}
                        {% set words = content.split()|length %}
                        {% set chars = content|length %}
                        –°—Ç—Ä–æ–∫: {{ lines }} | –°–ª–æ–≤: {{ words }} | –°–∏–º–≤–æ–ª–æ–≤: {{ chars }}
                    </div>
                </div>
                
                <form method="POST" action="{{ url_for('main.edit_file', repo_id=repo.id, filepath=filepath) }}">
                    {{ form.hidden_tag() }}
                    
                    <div class="form-group">
                        {{ form.content(class="form-control", id="file-content") }}
                        {% if form.content.errors %}
                            <small style="color: #721c24;">
                                {% for error in form.content.errors %}
                                    {{ error }}<br>
                                {% endfor %}
                            </small>
                        {% endif %}
                    </div>
                    
                    <div class="form-actions">
                        {{ form.submit(class="btn-primary") }}
                        <a href="{{ url_for('main.repo_view', repo_id=repo.id) }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
                        <button type="button" class="btn" onclick="clearEditor()" title="–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä">
                            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="info-section">
            <div class="file-info">
                <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ</h3>
                <ul>
                    <li><strong>–ò–º—è —Ñ–∞–π–ª–∞:</strong> {{ form.filename.data }}</li>
                    <li><strong>–ü—É—Ç—å:</strong> {{ filepath }}</li>
                    <li><strong>–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:</strong> {{ repo.name }}</li>
                    <li><strong>–í–ª–∞–¥–µ–ª–µ—Ü:</strong> {{ repo.owner.username }}</li>
                    <li><strong>–¢–∏–ø:</strong> 
                        {% set ext = form.filename.data.split('.')[-1].lower() if '.' in form.filename.data else 'text' %}
                        {% if ext in ['py', 'js', 'html', 'css', 'md', 'json', 'xml'] %}
                            –ö–æ–¥ (.{{ ext }})
                        {% elif ext in ['txt', 'md'] %}
                            –¢–µ–∫—Å—Ç
                        {% else %}
                            –§–∞–π–ª (.{{ ext }})
                        {% endif %}
                    </li>
                </ul>
            </div>
            
            <div class="file-tips">
                <h4>üí° –°–æ–≤–µ—Ç—ã –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</h4>
                <ul>
                    <li>–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –∫–æ–¥–∞</li>
                    <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∫—É</li>
                    <li>–î–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Enter</li>
                    <li>Tab —Å–æ–∑–¥–∞–µ—Ç –æ—Ç—Å—Ç—É–ø –≤ 4 –ø—Ä–æ–±–µ–ª–∞</li>
                    <li>–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–æ–º–º–∏—Ç</li>
                </ul>
                
                <h4 style="margin-top: 20px;">‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</h4>
                <ul>
                    <li><strong>Ctrl+S</strong> - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</li>
                    <li><strong>Ctrl+Z</strong> - –û—Ç–º–µ–Ω–∏—Ç—å</li>
                    <li><strong>Ctrl+Y</strong> - –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</li>
                    <li><strong>Ctrl+A</strong> - –í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</li>
                    <li><strong>Tab</strong> - –û—Ç—Å—Ç—É–ø</li>
                </ul>
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid;">
                    <h4>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ</h4>
                    <p>–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–æ–º–º–∏—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "–ò–∑–º–µ–Ω–µ–Ω —Ñ–∞–π–ª: {{ form.filename.data }}"</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
    document.addEventListener('keydown', function(e) {
        // Ctrl+S - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            document.querySelector('form').submit();
        }
        
        // Ctrl+Z - –æ—Ç–º–µ–Ω–∏—Ç—å (–±—Ä–∞—É–∑–µ—Ä –¥–µ–ª–∞–µ—Ç —ç—Ç–æ —Å–∞–º)
        // Ctrl+Y - –ø–æ–≤—Ç–æ—Ä–∏—Ç—å (–±—Ä–∞—É–∑–µ—Ä –¥–µ–ª–∞–µ—Ç —ç—Ç–æ —Å–∞–º)
        
        // Ctrl+A - –≤—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
        if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
            var editor = document.getElementById('file-content');
            if (editor === document.activeElement) {
                e.preventDefault();
                editor.select();
            }
        }
    });
    
    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    function clearEditor() {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
            document.getElementById('file-content').value = '';
        }
    }
    
    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    var originalContent = document.getElementById('file-content').value;
    var editor = document.getElementById('file-content');
    
    editor.addEventListener('blur', function() {
        var currentContent = editor.value;
        if (originalContent !== currentContent) {
            // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            console.log('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–æ. –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å!');
        }
    });
    
    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤
    function detectSyntax() {
        var filename = '{{ form.filename.data }}'.toLowerCase();
        var editor = document.getElementById('file-content');
        
        if (filename.endsWith('.py')) {
            editor.style.color = '#3572A5';
        } else if (filename.endsWith('.js')) {
            editor.style.color = '#F1E05A';
        } else if (filename.endsWith('.html')) {
            editor.style.color = '#E34C26';
        } else if (filename.endsWith('.css')) {
            editor.style.color = '#563D7C';
        } else if (filename.endsWith('.md')) {
            editor.style.color = '#083FA1';
        }
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ—Ç–µ–∫—Ç–æ—Ä —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', detectSyntax);
</script>
{% endblock %}